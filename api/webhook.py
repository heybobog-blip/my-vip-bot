import os
import json
import asyncio
import re
import requests  # ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ module ‡∏ô‡∏µ‡πâ
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ApplicationBuilder, ContextTypes, CommandHandler, MessageHandler, filters, CallbackQueryHandler
from http.server import BaseHTTPRequestHandler

# =================‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö=================
TOKEN = os.environ.get("TELEGRAM_TOKEN")

# ‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡πà‡∏≤‡∏ö‡∏≠‡∏ó‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß)
ADMIN_GROUP_ID = -1003614142313

# ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≠‡∏ó‡∏à‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏≠‡∏á)
MY_PHONE_NUMBER = "0659325591" 

# =========================================================
# [‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤]
# =========================================================
SELECTABLE_ROOMS = {
    "200": [
        {"id": -1003465527678, "name": "VVIP V1"},
        {"id": -1003465527678, "name": "VVIP V2"},
    ],
    "400": [
        {"id": -1003477489997, "name": "VVIP V1 SAVE"}
    ]
}

ALL_ACCESS_ROOMS = [
    {"id": -1003477489997, "name": "VVIP V1 SAVE"},
    # {"id": -1003465527678, "name": "VVIP V1"}, 
]

# ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì
THANK_YOU_TEXT = "‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ã‡∏±‡∏û‡∏û‡∏≠‡∏£‡πå‡∏ï ‡∏ù‡∏≤‡∏Å‡∏û‡∏¥‡∏°‡∏û‡πå +1 ‡πÅ‡∏•‡∏∞ ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏° VVIP ‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö"

# ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ö‡∏≠‡∏ó
application = ApplicationBuilder().token(TOKEN).build()

# =========================================================
# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡∏∞‡∏ã‡∏≠‡∏á TrueMoney (‡∏â‡∏ö‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏° User-Agent ‡∏´‡∏•‡∏≠‡∏Å server)
# =========================================================
def redeem_truemoney(url, phone_number):
    try:
        # ‡∏î‡∏∂‡∏á‡∏£‡∏´‡∏±‡∏™ Voucher ‡∏à‡∏≤‡∏Å URL
        match = re.search(r'v=([a-zA-Z0-9]+)', url)
        if not match:
            return {"status": "error", "message": "‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏•‡∏¥‡πâ‡∏á‡∏Å‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"}
        
        voucher_code = match.group(1)
        
        # [‡πÅ‡∏Å‡πâ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 1] ‡πÄ‡∏û‡∏¥‡πà‡∏° User-Agent ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Chrome Browser
        headers = {
            'Content-Type': 'application/json',
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
            'Accept': 'application/json',
            'Origin': 'https://gift.truemoney.com',
            'Referer': 'https://gift.truemoney.com/'
        }
        
        payload = {
            "mobile": phone_number,
            "voucher_hash": voucher_code
        }
        
        response = requests.post(
            f"https://gift.truemoney.com/campaign/vouchers/{voucher_code}/redeem", 
            json=payload, 
            headers=headers,
            timeout=15
        )
        
        # [‡πÅ‡∏Å‡πâ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 2] ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤ TrueMoney ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô JSON ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if response.status_code != 200:
             return {"status": "error", "message": f"Server ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (Code: {response.status_code}) ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏£‡∏≤‡∏∞ IP ‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®"}

        try:
            data = response.json()
        except json.JSONDecodeError:
            return {"status": "error", "message": "‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å TrueMoney ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (Response ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON)"}
        
        if data['status']['code'] == 'SUCCESS':
            amount = float(data['data']['my_ticket']['amount_baht'])
            sender_name = data['data']['owner_profile']['nickname']
            return {"status": "success", "amount": int(amount), "sender": sender_name}
        
        elif data['status']['code'] == 'CANNOT_GET_OWN_VOUCHER':
            return {"status": "error", "message": "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡∏ã‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ"}
        elif data['status']['code'] == 'TARGET_USER_REDEEMED':
             return {"status": "error", "message": "‡∏ã‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏£‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß"}
        elif data['status']['code'] == 'VOUCHER_OUT_OF_STOCK':
             return {"status": "error", "message": "‡∏ã‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß"}
        else:
            return {"status": "error", "message": f"‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: {data['status']['code']}"}

    except Exception as e:
        return {"status": "error", "message": str(e)}

# =========================================================
# ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á Bot Handlers
# =========================================================

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    WELCOME_TEXT = """
üßß **‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ "‡∏ã‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç TrueMoney" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô** üßß
‚ùå ‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡πÇ‡∏≠‡∏ô‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ / ‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏™‡πÅ‡∏Å‡∏ô QR Code

üëá **‡πÄ‡∏£‡∏ó‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤**
‚úÖ **200 ‡∏ö‡∏≤‡∏ó** : ‡∏î‡∏π‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏° (‡πÄ‡∏ã‡∏ü‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)
‚úÖ **400 ‡∏ö‡∏≤‡∏ó** : ‡∏î‡∏π + ‡πÄ‡∏ã‡∏ü‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏î‡πâ üíæ
üèÜ **999 ‡∏ö‡∏≤‡∏ó** : ‡πÄ‡∏´‡∏°‡∏≤‡∏ñ‡∏≤‡∏ß‡∏£ ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°!

ü§ñ **‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ 24 ‡∏ä‡∏°.**
‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏™‡πà‡∏á "‡∏•‡∏¥‡πâ‡∏á‡∏Å‡πå‡∏ã‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç" ‡∏°‡∏≤‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó‡∏ô‡∏µ‡πâ
‡∏ö‡∏≠‡∏ó‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏ó‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ!
"""
    keyboard = [
        [InlineKeyboardButton("üí¨ ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Admin (1)", url="https://t.me/ZeinJu001")],
        [InlineKeyboardButton("üí¨ ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Admin (2)", url="https://t.me/duded16")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    await context.bot.send_message(
        chat_id=update.effective_chat.id, 
        text=WELCOME_TEXT, 
        reply_markup=reply_markup,
        parse_mode='Markdown'
    )

async def reject_slip(update: Update, context: ContextTypes.DEFAULT_TYPE):
    warning_text = """
‚ùå **‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠ QR Code ‡∏Ñ‡∏£‡∏±‡∏ö**

‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô **"‡∏•‡∏¥‡πâ‡∏á‡∏Å‡πå‡∏ã‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç TrueMoney"** ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏£‡∏±‡∏ö
"""
    await update.message.reply_text(warning_text)

async def handle_truemoney(update: Update, context: ContextTypes.DEFAULT_TYPE):
    link = update.message.text.strip()
    user_id = update.message.from_user.id
    user_name = update.message.from_user.first_name

    await update.message.reply_text("ü§ñ ‡∏ö‡∏≠‡∏ó‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏•‡∏¥‡πâ‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡∏Ñ‡∏£‡∏±‡∏ö...")

    # ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô
    result = await asyncio.to_thread(redeem_truemoney, link, MY_PHONE_NUMBER)

    # -----------------------------------------------------
    # ‡∏Å‡∏£‡∏ì‡∏µ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    # -----------------------------------------------------
    if result['status'] == 'success':
        amount = result['amount'] 
        sender = result['sender']
        
        # ‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
        admin_report = f"üí∞ **‡∏ö‡∏≠‡∏ó‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!**\n\n‡∏à‡∏≤‡∏Å: {user_name} (ID: {user_id})\n‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô: {amount} ‡∏ö‡∏≤‡∏ó\n‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏ã‡∏≠‡∏á: {sender}\n\n‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏•‡∏¥‡πâ‡∏á‡∏Å‡πå‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤..."
        try:
            await context.bot.send_message(chat_id=ADMIN_GROUP_ID, text=admin_report)
        except:
            pass 

        # Auto Approve
        if amount >= 999:
            links_keyboard = []
            for group in ALL_ACCESS_ROOMS:
                invite = await context.bot.create_chat_invite_link(
                    chat_id=group["id"], member_limit=1, name=f"Auto 999 {user_id}"
                )
                links_keyboard.append([InlineKeyboardButton(f"‡πÄ‡∏Ç‡πâ‡∏≤ {group['name']}", url=invite.invite_link)])
            
            final_markup = InlineKeyboardMarkup(links_keyboard)
            await update.message.reply_text(
                f"‚úÖ **‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î {amount} ‡∏ö‡∏≤‡∏ó ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢**\nüéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå VIP ‡∏ñ‡∏≤‡∏ß‡∏£ (‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á)\n\n‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö:",
                reply_markup=final_markup
            )

        elif str(amount) in SELECTABLE_ROOMS:
            rooms = SELECTABLE_ROOMS[str(amount)]
            customer_keyboard = []
            for room in rooms:
                callback_str = f"select_room_{room['id']}_{amount}"
                customer_keyboard.append([InlineKeyboardButton(f"‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤ {room['name']}", callback_data=callback_str)])
            
            cust_markup = InlineKeyboardMarkup(customer_keyboard)
            await update.message.reply_text(
                f"‚úÖ **‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î {amount} ‡∏ö‡∏≤‡∏ó ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢**\nüëá ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ 1 ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô):",
                reply_markup=cust_markup
            )
        
        else:
            await update.message.reply_text(
                f"‚úÖ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î {amount} ‡∏ö‡∏≤‡∏ó (‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à‡∏õ‡∏Å‡∏ï‡∏¥)\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Ñ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ô‡∏µ‡πâ‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö"
            )
            contact_kb = [[InlineKeyboardButton("üí¨ ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Admin", url="https://t.me/ZeinJu001")]]
            await update.message.reply_text("‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô:", reply_markup=InlineKeyboardMarkup(contact_kb))

    # -----------------------------------------------------
    # ‡∏Å‡∏£‡∏ì‡∏µ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    # -----------------------------------------------------
    else:
        error_msg = result['message']
        contact_kb = [[InlineKeyboardButton("üí¨ ‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô", url="https://t.me/ZeinJu001")]]
        
        # ‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
        await update.message.reply_text(
            f"‚ùå **‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à**\n\n‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏: {error_msg}\n\n‡∏´‡∏≤‡∏Å‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏•‡∏¥‡πâ‡∏á‡∏Å‡πå‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö",
            reply_markup=InlineKeyboardMarkup(contact_kb)
        )

# ---------------------------------------------------------
# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î
# ---------------------------------------------------------
async def button_click(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    data = query.data

    if data.startswith("select_room_"):
        try:
            parts = data.split('_')
            target_group_id = int(parts[2])
            price_label = parts[3]

            invite_link_obj = await context.bot.create_chat_invite_link(
                chat_id=target_group_id, member_limit=1, name=f"Auto Select {price_label}"
            )
            
            link_keyboard = [[InlineKeyboardButton("‚≠êÔ∏è ‡∏Å‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‚≠êÔ∏è", url=invite_link_obj.invite_link)]]
            link_markup = InlineKeyboardMarkup(link_keyboard)
            
            await query.edit_message_text(
                text=f"‚úÖ **‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢**\n\n‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö:\n(‡∏•‡∏¥‡πâ‡∏á‡∏Å‡πå‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)",
                reply_markup=link_markup
            )
            
            await context.bot.send_message(chat_id=query.from_user.id, text=THANK_YOU_TEXT)

        except Exception as e:
            await context.bot.send_message(chat_id=query.from_user.id, text="‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡πâ‡∏á‡∏Å‡πå ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô")

# ===========================================================
# Server
# ===========================================================
application.add_handler(CommandHandler('start', start))
application.add_handler(MessageHandler(filters.Regex("gift.truemoney.com"), handle_truemoney))
application.add_handler(MessageHandler(filters.PHOTO, reject_slip))
application.add_handler(CallbackQueryHandler(button_click))

class handler(BaseHTTPRequestHandler):
    def do_POST(self):
        content_len = int(self.headers.get('Content-Length'))
        post_body = self.rfile.read(content_len)
        json_string = post_body.decode('utf-8')
        
        update_data = json.loads(json_string)
        
        async def main():
            async with application:
                update = Update.de_json(update_data, application.bot)
                await application.process_update(update)

        try:
            asyncio.run(main())
        except RuntimeError:
            loop = asyncio.get_event_loop()
            loop.run_until_complete(main())

        self.send_response(200)
        self.end_headers()
        self.wfile.write(b'OK')

    def do_GET(self):
        self.send_response(200)
        self.end_headers()
        self.wfile.write(b"Bot is running!")
